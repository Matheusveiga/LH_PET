@model LH_PET.Models.User
@{
    ViewData["Title"] = "Registro";
}

<h2 class="text-center mt-4">Registro</h2>

<form asp-action="Registro" method="post" class="container mt-4">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })
    <div class="mb-3">
        <label asp-for="Username" class="form-label"></label>
        <input asp-for="Username" class="form-control" />
        <span asp-validation-for="Username" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Email" class="form-label"></label>
        <input asp-for="Email" class="form-control" />
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Password" class="form-label">Senha</label>
        <input asp-for="Password" type="password" class="form-control" />
        <span asp-validation-for="Password" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ConfirmPassword" class="form-label">Confirme a Senha</label>
        <input asp-for="ConfirmPassword" type="password" class="form-control" />
        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Força da senha</label>
        <div class="progress">
            <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width:0%"></div>
        </div>
        <small id="passwordStrengthText" class="form-text text-muted"></small>
    </div>

    <div class="mb-3">
        <small id="passwordMatchText" class="form-text"></small>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <button type="submit" id="submitBtn" class="btn btn-primary">Registrar</button>
        <p class="mb-0">Já tem uma conta? <a href="@Url.Action("Login", "Autenticacao")" class="link-primary">Entrar</a></p>
    </div>
</form>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        (function () {
            const passwordInput = document.querySelector('input[name="Password"]');
            const confirmInput = document.querySelector('input[name="ConfirmPassword"]');
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('passwordStrengthText');
            const matchText = document.getElementById('passwordMatchText');
            const submitBtn = document.getElementById('submitBtn');

            function checkStrength(pw) {
                let score = 0;
                if (!pw) return 0;
                if (pw.length >= 8) score += 1;
                if (/[A-Z]/.test(pw)) score += 1;
                if (/[a-z]/.test(pw)) score += 1;
                if (/[0-9]/.test(pw)) score += 1;
                if (/[^A-Za-z0-9]/.test(pw)) score += 1;
                return score; // 0..5
            }

            function update() {
                const pw = passwordInput ? passwordInput.value : '';
                const cpw = confirmInput ? confirmInput.value : '';
                const score = checkStrength(pw);
                const percent = (score / 5) * 100;
                strengthBar.style.width = percent + '%';
                strengthBar.className = 'progress-bar';
                if (score <= 2) { strengthBar.classList.add('bg-danger'); strengthText.textContent = 'Fraca'; }
                else if (score == 3) { strengthBar.classList.add('bg-warning'); strengthText.textContent = 'Média'; }
                else { strengthBar.classList.add('bg-success'); strengthText.textContent = 'Forte'; }

                if (pw && cpw && pw === cpw) {
                    matchText.textContent = 'Senhas coincidem.';
                    matchText.className = 'form-text text-success';
                } else if (cpw.length > 0) {
                    matchText.textContent = 'Senhas não coincidem.';
                    matchText.className = 'form-text text-danger';
                } else {
                    matchText.textContent = '';
                }

                // Disable submit unless strong enough and match
                const isStrong = score >= 4; // require at least 4/5
                const isMatch = pw && cpw && pw === cpw;
                submitBtn.disabled = !(isStrong && isMatch);
            }

            if (passwordInput) passwordInput.addEventListener('input', update);
            if (confirmInput) confirmInput.addEventListener('input', update);
            // initial
            update();
        })();
    </script>
}
